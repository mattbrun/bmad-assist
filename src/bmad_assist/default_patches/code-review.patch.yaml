patch:
  name: "code-review-optimizer"
  version: "1.0.0"
  author: "Pawel N"
  description: "Optimizes code-review workflow for Multi-LLM automation - removes interactive steps, produces code review report to stdout only"

compatibility:
  bmad_version: "6.0.0-alpha.22"
  workflow: "code-review"
  # NOTE: This patch is compatible with the 5-step code-review workflow
  # Steps: 1 (file discovery), 2 (attack plan), 3 (adversarial review),
  #        4 (findings + fixes), 5 (status sync)

git_intelligence:
  enabled: true
  embed_marker: "git-intelligence"
  no_git_message: |
    This project is not under git version control.
    Do NOT attempt to run git commands - they will fail.
    Focus on embedded context and file reading instead.
  commands:
    - name: "Recent Commits (last 5)"
      command: "git log --oneline -5"
    - name: "Story File History"
      command: "git log --oneline -3 -- '**/{{epic_num}}-{{story_num}}-*.md' 2>/dev/null || echo '(no history)'"
    # NOTE: git diff is embedded separately as [git-diff] in context files
    # Excluding docs/*.md from diff is handled by _capture_git_diff in code_review.py

transforms:
  # === STEP REMOVAL (handled by compiler) ===
  # Original workflow has 5 steps:
  #   1. Load story and discover changes (file/git discovery)
  #   2. Build review attack plan
  #   3. Execute adversarial review
  #   4. Present findings and fix them (has <o> output block + <ask>)
  #   5. Update story status and sync sprint tracking

  # NOTE: Step removal and renumbering is now handled deterministically by post_process rules.
  # Original workflow has 5 steps, steps 1 and 5 are removed, remaining steps 2-4 renumbered to 1-3.
  - "Remove step 1 completely - all file discovery and git diff analysis is handled by the compiler which embeds story file, modified source files, architecture, and project context in the <context> section"
  - "Remove step 5 completely - story status updates and sprint-status.yaml sync are handled by the orchestrator after synthesis; validator only produces a report"
  - "CRITICAL: KEEP steps 2, 3, and 4 WITHOUT content modifications - these contain the core adversarial review logic"
  - "In step 4 (becomes step 3 after renumbering): Remove the <ask> block asking user for fix options, and remove all <check if='user chooses...'> blocks - validator cannot interact with user"
  - "In step 4 (becomes step 3 after renumbering): KEEP the <o> output block containing the code review report template - this is the validator's output format"

  # === REFERENCE UPDATES ===
  - "Replace all {installed_path} references with 'embedded context' - compiler pre-loads all needed files"
  - "Replace the <critical> that says 'You MUST have already loaded and processed: {installed_path}/workflow.yaml' with: 'All configuration and context is available in the VARIABLES section below. Use these resolved values directly.'"

  # === OUTPUT FILE PATH (REMOVED - orchestrator handles saving) ===
  # NOTE: In Multi-LLM architecture, validators do NOT write files.
  # The orchestrator captures stdout and saves reports with anonymized IDs.
  - "Remove any references to default_output_file - validators output to stdout only"
  - "Remove any instructions to create directories or write files"
  - "Remove any instructions to save story files or update story status"

  # === SCOPE LIMITATION (READ-ONLY) ===
  - "Add ONE CRITICAL instruction at workflow start (first element after <workflow>): 'SCOPE LIMITATION: You are a READ-ONLY VALIDATOR. Output your code review report to stdout ONLY. Do NOT create files, do NOT modify files, do NOT use Write/Edit/Bash tools. Your stdout output will be captured and saved by the orchestration system.'"

  # === STEP 4 SIMPLIFICATION (stdout output only) ===
  - "In step 4 (Present findings), simplify to: (1) Generate the code review report using the <o> block template as FORMAT GUIDE, (2) Replace all {{placeholders}} with actual values from your analysis, (3) Output the complete report to stdout, (4) Do NOT save to any file - orchestrator handles persistence"

  # === REPORT EXTRACTION MARKERS (critical for Multi-LLM) ===
  - "Add a <critical> instruction in step 4 (Present findings) with EXACT text: 'OUTPUT MARKERS REQUIRED: Your code review report MUST start with the marker <!-- CODE_REVIEW_REPORT_START --> on its own line BEFORE the report content, and MUST end with the marker <!-- CODE_REVIEW_REPORT_END --> on its own line AFTER the final line. The orchestrator extracts ONLY content between these markers. Any text outside the markers (thinking, commentary) will be discarded.'"

  # === PLACEHOLDER HANDLING ===
  - "Replace {{fixed_count}} with literal '0' - validators do not fix issues"
  - "Replace {{action_count}} with literal '0' - validators do not create action items"

# Post-process rules extend defaults.yaml
# NOTE: These run AFTER LLM transforms, on final .tpl.xml output
# IMPORTANT: Order matters! User interaction removal MUST happen before end marker insertion
post_process:
  # === STEP REMOVAL (deterministic regex fallback) ===
  # Remove step 1 entirely (file discovery - compiler handles)
  - pattern: '<step n="1"[^>]*>.*?</step>'
    replacement: "<!-- Step 1 removed: file discovery handled by compiler -->"
    flags: "DOTALL"

  # Remove step 5 entirely (story status sync - orchestrator handles)
  - pattern: '<step n="5"[^>]*>.*?</step>'
    replacement: "<!-- Step 5 removed: status sync handled by orchestrator -->"
    flags: "DOTALL"

  # === STEP RENUMBERING (after step removal) ===
  # Remaining steps: 2, 3, 4 â†’ renumber to 1, 2, 3
  - pattern: '<step n="2"'
    replacement: '<step n="1"'
    flags: ""
  - pattern: '<step n="3"'
    replacement: '<step n="2"'
    flags: ""
  - pattern: '<step n="4"'
    replacement: '<step n="3"'
    flags: ""

  # === USER INTERACTION REMOVAL (must run BEFORE marker insertion) ===
  # Remove <ask> blocks - automation has no user
  - pattern: '\s*<ask>.*?</ask>\s*'
    replacement: ""
    flags: "DOTALL"

  # Remove <check if="user chooses..."> blocks - no user choices
  - pattern: '\s*<check if="user chooses[^"]*">.*?</check>\s*'
    replacement: ""
    flags: "DOTALL"

  # Remove HALT instructions
  - pattern: '<action>HALT[^<]*</action>'
    replacement: ""
    flags: "IGNORECASE"

  # Remove invoke-workflow (handled by bmad-assist orchestration)
  - pattern: '<invoke-workflow[^>]*>.*?</invoke-workflow>'
    replacement: ""
    flags: "DOTALL"

  # Remove invoke-protocol (step 1 has discover_inputs)
  - pattern: '\s*<invoke-protocol[^>]*/>\s*'
    replacement: ""
    flags: ""

  # Remove invoke-task (not executable by validators)
  - pattern: '<invoke-task[^>]*>.*?</invoke-task>'
    replacement: ""
    flags: "DOTALL"

  # Remove template-output interactive markers
  - pattern: '<template-output[^>]*>[^<]*</template-output>'
    replacement: ""
    flags: "DOTALL"

  # === CODE_REVIEW_REPORT MARKERS (after step renumbering and user interaction removal) ===
  # NOTE: code-review has template: false - output is in <o> block, not <output-template>
  # CRITICAL ORDERING: These patterns run AFTER step renumbering, so step 4 is now step 3.

  # Add start marker after <o> opening tag in step 3 (was step 4 before renumbering)
  - pattern: '(<step n="3"[^>]*>.*?<o>)'
    replacement: '\1\n<!-- CODE_REVIEW_REPORT_START -->'
    flags: "DOTALL"

  # Add end marker before </o> closing tag
  - pattern: '(</o>)(\s*</step>)'
    replacement: '\n<!-- CODE_REVIEW_REPORT_END -->\n\1\2'
    flags: "DOTALL"

  # DEDUP AFTER INSERTION: Remove duplicate markers (LLM + post_process might both add)
  - pattern: '(<!-- CODE_REVIEW_REPORT_START -->\s*){2,}'
    replacement: '<!-- CODE_REVIEW_REPORT_START -->\n'
    flags: ""
  - pattern: '(<!-- CODE_REVIEW_REPORT_END -->\s*){2,}'
    replacement: '<!-- CODE_REVIEW_REPORT_END -->\n'
    flags: ""

  # === PLACEHOLDER REPLACEMENT ===
  # Replace {{fixed_count}} with literal "0" (validators don't fix)
  - pattern: '\{\{fixed_count\}\}'
    replacement: "0"
    flags: ""

  # Replace {{action_count}} with literal "0" (validators don't create actions)
  - pattern: '\{\{action_count\}\}'
    replacement: "0"
    flags: ""

  # === FILE/STATUS REFERENCE CLEANUP ===
  # Replace {default_output_file} with stdout instruction
  - pattern: '\{default_output_file\}'
    replacement: "(stdout output)"
    flags: ""

  # Remove action tags that save story files
  - pattern: '<action>[^<]*(?:Save|save)[^<]*story[^<]*</action>'
    replacement: ""
    flags: "IGNORECASE"

  # Remove action tags that update story status
  - pattern: '<action>[^<]*(?:Update|update)[^<]*story[^<]*Status[^<]*</action>'
    replacement: ""
    flags: "IGNORECASE"

  # Remove action tags that append to story
  - pattern: '<action>[^<]*(?:Append|append)[^<]*story[^<]*</action>'
    replacement: ""
    flags: "IGNORECASE"

validation:
  # NOTE: Step number validation is REMOVED because:
  # 1. post_process rules handle step removal/renumbering deterministically
  # 2. LLM transforms are unreliable for step manipulation
  # We only validate content-level requirements that LLM must handle.
  must_contain:
    - "<step"
    - "<critical"
    - "/[Rr]eport/"  # case-insensitive
    - "/[Aa]dversarial/"  # adversarial review preserved
    - "CODE_REVIEW_REPORT_START"
    - "CODE_REVIEW_REPORT_END"
  must_not_contain:
    - "{installed_path}"
    - "HALT"
    - "<ask>"
    - "Your choice:"
    - "Save story"
    - "invoke-protocol"
    - "{{fixed_count}}"
    - "{{action_count}}"
    # NOTE: Do NOT check for {{placeholders}} - they SHOULD be in the
    # template because the VALIDATOR fills them in later, not the PATCHER
    # NOTE: Step number checks removed - post_process handles deterministically
